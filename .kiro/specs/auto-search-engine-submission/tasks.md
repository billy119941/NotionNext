# 自动搜索引擎提交功能实现计划

## 实现任务列表

- [x] 1. 创建项目基础结构和配置文件
  - 创建 `scripts/` 目录用于存放自动提交脚本
  - 创建配置文件 `config/search-engine-submission.json`
  - 设置 package.json 依赖项（xml2js, axios, nodemailer 等）
  - _需求: 需求8.1, 需求8.2_

- [x] 2. 实现 Sitemap 检测核心功能
  - [x] 2.1 创建 SitemapDetector 类
    - 实现 sitemap.xml 获取功能
    - 实现 XML 解析和 URL 提取
    - 实现与缓存版本的差异比较逻辑
    - _需求: 需求2.1, 需求2.2, 需求2.3_

  - [x] 2.2 实现缓存管理功能
    - 创建 CacheManager 类处理 sitemap 缓存
    - 实现基于文件的缓存存储和读取
    - 实现缓存有效性验证
    - _需求: 需求2.4_

- [x] 3. 实现 URL 标准化处理
  - [x] 3.1 创建 URLNormalizer 类
    - 实现 .html 后缀移除功能
    - 实现 URL 格式验证
    - 实现 URL 去重处理
    - _需求: 需求1.1, 需求1.2, 需求1.3_

- [x] 4. 实现 Google 搜索引擎提交功能
  - [x] 4.1 创建 Google API 客户端
    - 集成 Google Indexing API
    - 实现服务账户认证
    - 实现批量 URL 提交功能
    - _需求: 需求3.1, 需求3.2_

  - [x] 4.2 实现 Google API 错误处理
    - 处理 API 限制和配额错误
    - 实现重试机制
    - 记录提交结果和错误信息
    - _需求: 需求3.3, 需求3.4, 需求3.5_

- [x] 5. 实现 Bing 搜索引擎提交功能
  - [x] 5.1 创建 Bing API 客户端
    - 集成 Bing Webmaster API
    - 实现 API 密钥认证
    - 实现批量 URL 提交功能
    - _需求: 需求4.1, 需求4.2_

  - [x] 5.2 实现 Bing API 错误处理
    - 处理 API 限制和配额错误
    - 实现重试机制
    - 记录提交结果和错误信息
    - _需求: 需求4.3, 需求4.4, 需求4.5_

- [x] 6. 实现统一的搜索引擎提交器
  - [x] 6.1 创建 SearchEngineSubmitter 主类
    - 整合 Google 和 Bing 客户端
    - 实现并行提交逻辑
    - 实现提交结果汇总
    - _需求: 需求3.1, 需求4.1_

- [x] 7. 实现错误处理和重试机制
  - [x] 7.1 创建 ErrorHandler 类
    - 实现指数退避重试策略
    - 实现错误分类和处理逻辑
    - 实现失败 URL 的持久化存储
    - _需求: 需求6.1, 需求6.2, 需求6.3, 需求6.6_

  - [x] 7.2 实现邮件通知功能
    - 集成 nodemailer 发送邮件
    - 创建邮件模板（成功/失败报告）
    - 实现通知触发条件判断
    - _需求: 需求6.4, 需求7.5_

- [x] 8. 创建主执行脚本
  - [x] 8.1 创建 submit-urls.js 主脚本
    - 整合所有组件的执行流程
    - 实现命令行参数处理
    - 实现执行日志记录
    - _需求: 需求5.4, 需求7.1, 需求7.2_

  - [x] 8.2 实现执行报告生成
    - 创建执行统计和报告功能
    - 实现提交成功率计算
    - 生成详细的执行日志
    - _需求: 需求7.1, 需求7.2, 需求7.3_

- [x] 9. 配置 GitHub Actions 工作流
  - [x] 9.1 创建 GitHub Actions 工作流文件
    - 创建 `.github/workflows/search-engine-submission.yml`
    - 配置定时触发（每2小时）和手动触发
    - 设置 Node.js 环境和依赖安装
    - _需求: 需求5.1, 需求5.2_

  - [x] 9.2 配置环境变量和密钥
    - 设置 GitHub Secrets 配置说明
    - 实现环境变量验证逻辑
    - 配置缓存策略
    - _需求: 需求5.3, 需求8.3, 需求8.4_

- [x] 10. 实现单元测试
  - [x] 10.1 为核心组件编写单元测试
    - 测试 SitemapDetector 的 sitemap 解析和差异检测
    - 测试 URLNormalizer 的 URL 处理逻辑
    - 测试 ErrorHandler 的重试机制
    - _需求: 需求2.1, 需求2.2, 需求1.1, 需求6.1_

  - [x] 10.2 为 API 客户端编写测试
    - 模拟 Google API 调用和响应处理
    - 模拟 Bing API 调用和响应处理
    - 测试错误场景和重试逻辑
    - _需求: 需求3.1, 需求3.3, 需求4.1, 需求4.3_

- [x] 11. 创建配置和文档
  - [x] 11.1 创建配置文件模板
    - 创建 `config/search-engine-submission.example.json`
    - 编写配置参数说明文档
    - 创建环境变量设置指南
    - _需求: 需求8.1, 需求8.5_

  - [x] 11.2 编写使用说明文档
    - 创建 README 文档说明如何设置和使用
    - 编写 Google 和 Bing API 配置指南
    - 创建故障排除指南
    - _需求: 需求5.3, 需求6.4_

- [ ] 12. 集成测试和部署验证
  - [ ] 12.1 进行端到端测试
    - 测试完整的 sitemap 检测到提交流程
    - 验证邮件通知功能
    - 测试 GitHub Actions 工作流执行
    - _需求: 需求5.1, 需求5.4, 需求6.4_

  - [ ] 12.2 生产环境部署验证
    - 配置生产环境的 GitHub Secrets
    - 执行首次手动触发测试
    - 验证定时任务正常运行
    - 监控首周执行情况和错误率
    - _需求: 需求5.2, 需求5.3, 需求7.4_