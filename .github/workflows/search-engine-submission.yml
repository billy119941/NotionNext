name: è‡ªåŠ¨æœç´¢å¼•æ“æäº¤

on:
  # æ¯2å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */2 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆä¸å®é™…æäº¤ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      force_submit:
        description: 'å¼ºåˆ¶æäº¤ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  NODE_VERSION: '18'
  SITEMAP_URL: 'https://www.shareking.vip/sitemap.xml'

jobs:
  submit-urls:
    name: æäº¤ URL åˆ°æœç´¢å¼•æ“
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci --only=production
          # å®‰è£…æœç´¢å¼•æ“æäº¤æ‰€éœ€çš„é¢å¤–ä¾èµ–
          npm install googleapis@144.0.0 nodemailer@6.9.15 xml2js@0.6.2

      - name: éªŒè¯ç¯å¢ƒå˜é‡
        run: |
          echo "ğŸ” éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "âš ï¸ GOOGLE_SERVICE_ACCOUNT_KEY æœªè®¾ç½®"
          else
            echo "âœ… GOOGLE_SERVICE_ACCOUNT_KEY å·²è®¾ç½®"
          fi
          
          if [ -z "${{ secrets.BING_API_KEY }}" ]; then
            echo "âš ï¸ BING_API_KEY æœªè®¾ç½®"
          else
            echo "âœ… BING_API_KEY å·²è®¾ç½®"
          fi

      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: .cache
          key: sitemap-cache-${{ runner.os }}-${{ hashFiles('config/search-engine-submission.json') }}
          restore-keys: |
            sitemap-cache-${{ runner.os }}-

      - name: è¿è¡Œ URL æäº¤
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          BING_API_KEY: ${{ secrets.BING_API_KEY }}
          NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
          SMTP_CONFIG: ${{ secrets.SMTP_CONFIG }}
          # æ ¹æ®è¾“å…¥å‚æ•°è®¾ç½®ç¯å¢ƒå˜é‡
          TEST_MODE: ${{ github.event.inputs.test_mode == 'true' && '--test' || '' }}
          FORCE_SUBMIT: ${{ github.event.inputs.force_submit }}
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨æœç´¢å¼•æ“æäº¤..."
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸŒ ç½‘ç«™: ${{ env.SITEMAP_URL }}"
          
          # å¦‚æœæ˜¯å¼ºåˆ¶æäº¤æ¨¡å¼ï¼Œæ¸…ç†ç¼“å­˜
          if [ "$FORCE_SUBMIT" = "true" ]; then
            echo "ğŸ§¹ å¼ºåˆ¶æäº¤æ¨¡å¼ï¼šæ¸…ç†ç¼“å­˜"
            rm -rf .cache
          fi
          
          # æ‰§è¡Œæäº¤è„šæœ¬
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            echo "ğŸ§ª è¿è¡Œåœ¨æµ‹è¯•æ¨¡å¼"
            npm run submit-urls:test
          else
            echo "ğŸ¯ è¿è¡Œåœ¨ç”Ÿäº§æ¨¡å¼"
            npm run submit-urls
          fi

      - name: ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: submission-logs-${{ github.run_number }}
          path: |
            .cache/*.json
            .cache/*.log
          retention-days: 7

      - name: å‘é€é€šçŸ¥ï¼ˆæˆåŠŸï¼‰
        if: success() && github.event.inputs.test_mode != 'true'
        run: |
          echo "âœ… URL æäº¤ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          echo "ğŸ“Š æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: å‘é€é€šçŸ¥ï¼ˆå¤±è´¥ï¼‰
        if: failure()
        run: |
          echo "âŒ URL æäº¤ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
          echo "ğŸ“Š æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ’¡ è¯·æ£€æŸ¥æ—¥å¿—ä»¥äº†è§£å¤±è´¥åŸå› "

  # å¥åº·æ£€æŸ¥ä»»åŠ¡ï¼ˆæ¯å¤©è¿è¡Œä¸€æ¬¡ï¼‰
  health-check:
    name: ç³»ç»Ÿå¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * *'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci --only=production
          npm install googleapis@144.0.0 nodemailer@6.9.15 xml2js@0.6.2

      - name: è¿è¡Œå¥åº·æ£€æŸ¥
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          BING_API_KEY: ${{ secrets.BING_API_KEY }}
        run: |
          echo "ğŸ¥ å¼€å§‹ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
          node scripts/diagnose-apis.js

      - name: æ£€æŸ¥é…é¢ä½¿ç”¨æƒ…å†µ
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          BING_API_KEY: ${{ secrets.BING_API_KEY }}
        run: |
          echo "ğŸ“Š æ£€æŸ¥ API é…é¢ä½¿ç”¨æƒ…å†µ..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ é…é¢æ£€æŸ¥è„šæœ¬